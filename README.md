## Deploying to Azure App Service

This Next.js application is configured to produce a standalone output, suitable for deployment to platforms like Azure App Service.

### Prerequisites

1.  **Azure Account:** You'll need an active Azure subscription.
2.  **Azure CLI (Optional but Recommended):** [Install Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
3.  **Node.js and npm:** Ensure you have a compatible version installed locally to build the project. [Install Node.js](https://nodejs.org/en)

### Build Steps

1.  **Install Dependencies:**
    In your local project root directory, run:
    ```bash
    npm install
    ```

2.  **Build for Production:**
    ```bash
    npm run build
    ```
    This command uses the `output: 'standalone'` setting in `next.config.ts`. The build output will be in the `.next/standalone` directory.

3.  **Prepare Standalone Output:**
    The `standalone` output needs your `public` assets and static Next.js assets. Copy them into the standalone directory from your project root:
    ```bash
    # On Linux/macOS
    cp -r public .next/standalone/public
    cp -r .next/static .next/standalone/.next/static

    # On Windows (using PowerShell)
    # Copy-Item -Path "public" -Destination ".next/standalone/public" -Recurse -Force
    # Copy-Item -Path ".next/static" -Destination ".next/standalone/.next/static" -Recurse -Force
    ```

4.  **Package for Deployment:**
    Create a .zip file containing all the contents of the `.next/standalone` directory.
    Navigate into the standalone directory first:
    ```bash
    cd .next/standalone
    ```
    Then, create the zip file (example for Linux/macOS):
    ```bash
    zip -r ../../deployment.zip .
    ```
    Then navigate back to your project root:
    ```bash
    cd ../..
    ```
    *(Adjust the zip command or use a graphical tool as per your OS and preferences. Ensure the zip file contains the contents of `.next/standalone`, not the folder itself as a top-level item.)*

### Azure App Service Setup & Deployment

1.  **Create Azure App Service:**
    *   In the Azure Portal, create a new "Web App".
    *   **Publish:** Code
    *   **Runtime stack:** Select "Node" (e.g., Node 18 LTS or Node 20 LTS).
    *   **Operating System:** Select "Linux".
    *   Choose an appropriate App Service Plan (pricing tier).

2.  **Configure Environment Variables:**
    In your Azure App Service, go to "Settings" -> "Configuration" -> "Application settings". Add the following, ensuring you use the correct values from your Azure AD App Registration:
    *   `GRAPH_CLIENT_ID`: Your Azure AD App's Client ID.
    *   `GRAPH_CLIENT_SECRET`: Your Azure AD App's Client Secret Value.
    *   `GRAPH_TENANT_ID`: Your Azure AD Tenant ID.
    *   `PORT`: (Optional, Azure usually sets this) Typically `8080`. Next.js standalone mode listens on the port specified by the `PORT` environment variable.
    *   `NEXT_PUBLIC_GROUP_TAG_LIST`: (Optional) A JSON string to customize the Autopilot Group Tags dropdown. See "Customizing Group Tags" section below for format.

3.  **Configure Startup Command:**
    In "Settings" -> "Configuration" -> "General settings", set the **Startup Command** to:
    ```
    node server.js
    ```
    This command executes the server file generated by the `standalone` output. Save the changes.

4.  **Deploy:**
    You can deploy `deployment.zip` using various methods:
    *   **Azure CLI:**
        ```bash
        az webapp deploy --resource-group <YourResourceGroupName> --name <YourAppServiceName> --src-path deployment.zip --type zip
        ```
    *   **VS Code Azure Tools Extension.**
    *   **Azure DevOps or GitHub Actions for CI/CD (Recommended for ongoing projects).**
    *   **Kudu (Zip Push Deploy):** Navigate to `https://<YourAppServiceName>.scm.azurewebsites.net/ZipDeployUI` and drag-and-drop your `deployment.zip`.

### Post-Deployment

*   Access your application via the URL provided by Azure App Service (e.g., `https://<yourappservicename>.azurewebsites.net`).
*   Monitor logs via "Monitoring" -> "Log stream" in the Azure portal for any issues.
*   It might take a few minutes for the app to start after deployment.


### Important Information
*   A Group Tag must be selected from the dropdown before uploading or pasting hashes.
*   Maximum file size: 5MB.
*   Maximum 1000 hashes per upload.
*   Supported formats: .txt or .csv (ensure hashes are in the third column if a CSV header is present, or one per line for .txt).
*   Each hash should be on a new line and be a valid Base64 string (typically the 4K HH).
*   The Intune upload requires proper Azure AD app registration and environment variables (GRAPH_CLIENT_ID, GRAPH_CLIENT_SECRET, GRAPH_TENANT_ID).

### Customizing Group Tags
The list of available Autopilot Group Tags in the dropdown can be customized via an environment variable.
*   **Environment Variable Name:** `NEXT_PUBLIC_GROUP_TAG_LIST`
*   **Format:** A JSON string representing an array of objects, where each object has a `displayName` (string, for the UI) and a `backendTag` (string, the value sent to Intune).
*   **Example:**
    ```json
    [
      {"displayName": "Quanta Services", "backendTag": "QCO"},
      {"displayName": "Nationwide Insurance", "backendTag": "NWI"}
      {"displayName": "Honda Moters Corp", "backendTag": "HMC"}
      {"displayName": "Chase Bank Ohio", "backendTag": "CBO"}
    ]
    ```
    To use this example, you would set the `NEXT_PUBLIC_GROUP_TAG_LIST` environment variable to the above JSON string (ensure it's a single line or properly escaped if your environment requires it).
*   If this environment variable is not set or is invalid JSON, the application will fall back to a default list of group tags.
*   NEXT_PUBLIC_GROUP_TAG_LIST='[{"displayName": "Quanta Services", "backendTag": "QCO"}, {"displayName": "Nationwide Insurance", "backendTag": "NWI"}, {"displayName": "Honda Moters Corp", "backendTag": "HMC"}, {"displayName": "Chase Bank Ohio", "backendTag": "CBO"}]'



